{"version":3,"file":"util.js","sources":["../../../src/config/util.ts"],"sourcesContent":["import { parseSemver } from '@sentry/core';\nimport * as fs from 'fs';\nimport { sync as resolveSync } from 'resolve';\n\n/**\n * Returns the version of Next.js installed in the project, or undefined if it cannot be determined.\n */\nexport function getNextjsVersion(): string | undefined {\n  const nextjsPackageJsonPath = resolveNextjsPackageJson();\n  if (nextjsPackageJsonPath) {\n    try {\n      const nextjsPackageJson: { version: string } = JSON.parse(\n        fs.readFileSync(nextjsPackageJsonPath, { encoding: 'utf-8' }),\n      );\n      return nextjsPackageJson.version;\n    } catch {\n      // noop\n    }\n  }\n\n  return undefined;\n}\n\nfunction resolveNextjsPackageJson(): string | undefined {\n  try {\n    return resolveSync('next/package.json', { basedir: process.cwd() });\n  } catch {\n    return undefined;\n  }\n}\n\n/**\n * Checks if the current Next.js version supports the runAfterProductionCompile hook.\n * This hook was introduced in Next.js 15.4.1. (https://github.com/vercel/next.js/pull/77345)\n *\n * @param version - version string to check.\n * @returns true if Next.js version is 15.4.1 or higher\n */\nexport function supportsProductionCompileHook(version: string): boolean {\n  const versionToCheck = version;\n  if (!versionToCheck) {\n    return false;\n  }\n\n  const { major, minor, patch } = parseSemver(versionToCheck);\n\n  if (major === undefined || minor === undefined || patch === undefined) {\n    return false;\n  }\n\n  if (major > 15) {\n    return true;\n  }\n\n  // For major version 15, check if it's 15.4.1 or higher\n  if (major === 15) {\n    if (minor > 4) {\n      return true;\n    }\n    if (minor === 4 && patch >= 1) {\n      return true;\n    }\n    return false;\n  }\n\n  return false;\n}\n\n/**\n * Checks if the current Next.js version supports native debug ids for turbopack.\n * This feature was first introduced in Next.js v15.6.0-canary.36 and marked stable in Next.js v16\n *\n * @param version - version string to check.\n * @returns true if Next.js version supports native debug ids for turbopack builds\n */\nexport function supportsNativeDebugIds(version: string): boolean {\n  if (!version) {\n    return false;\n  }\n\n  const { major, minor, prerelease } = parseSemver(version);\n\n  if (major === undefined || minor === undefined) {\n    return false;\n  }\n\n  // Next.js 16+ supports native debug ids\n  if (major >= 16) {\n    return true;\n  }\n\n  // For Next.js 15, check if it's 15.6.0-canary.36+\n  if (major === 15 && prerelease?.startsWith('canary.')) {\n    // Any canary version 15.7+ supports native debug ids\n    if (minor > 6) {\n      return true;\n    }\n\n    // For 15.6 canary versions, check if it's canary.36 or higher\n    if (minor === 6) {\n      const canaryNumber = parseInt(prerelease.split('.')[1] || '0', 10);\n      if (canaryNumber >= 36) {\n        return true;\n      }\n    }\n  }\n\n  return false;\n}\n\n/**\n * Checks if the current Next.js version uses Turbopack as the default bundler.\n * Starting from Next.js 15.6.0-canary.38, turbopack became the default for `next build`.\n *\n * @param version - Next.js version string to check.\n * @returns true if the version uses Turbopack by default\n */\nexport function isTurbopackDefaultForVersion(version: string): boolean {\n  if (!version) {\n    return false;\n  }\n\n  const { major, minor, prerelease } = parseSemver(version);\n\n  if (major === undefined || minor === undefined) {\n    return false;\n  }\n\n  // Next.js 16+ uses turbopack by default\n  if (major >= 16) {\n    return true;\n  }\n\n  // For Next.js 15, only canary versions 15.6.0-canary.40+ use turbopack by default\n  // Stable 15.x releases still use webpack by default\n  if (major === 15 && minor >= 6 && prerelease && prerelease.startsWith('canary.')) {\n    if (minor >= 7) {\n      return true;\n    }\n    const canaryNumber = parseInt(prerelease.split('.')[1] || '0', 10);\n    if (canaryNumber >= 40) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\n/**\n * Determines which bundler is actually being used based on environment variables,\n * CLI flags, and Next.js version.\n *\n * @param nextJsVersion - The Next.js version string\n * @returns 'turbopack', 'webpack', or undefined if it cannot be determined\n */\nexport function detectActiveBundler(nextJsVersion: string | undefined): 'turbopack' | 'webpack' | undefined {\n  if (process.env.TURBOPACK || process.argv.includes('--turbo')) {\n    return 'turbopack';\n  }\n\n  // Explicit opt-in to webpack via --webpack flag\n  if (process.argv.includes('--webpack')) {\n    return 'webpack';\n  }\n\n  // Fallback to version-based default behavior\n  if (nextJsVersion) {\n    const turbopackIsDefault = isTurbopackDefaultForVersion(nextJsVersion);\n    return turbopackIsDefault ? 'turbopack' : 'webpack';\n  }\n\n  // Unlikely but at this point, we just assume webpack for older behavior\n  return 'webpack';\n}\n"],"names":["resolveSync"],"mappings":"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"}