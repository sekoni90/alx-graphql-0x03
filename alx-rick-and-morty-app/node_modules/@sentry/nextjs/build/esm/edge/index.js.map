{"version":3,"file":"index.js","sources":["../../../src/edge/index.ts"],"sourcesContent":["import {\n  applySdkMetadata,\n  getGlobalScope,\n  getIsolationScope,\n  getRootSpan,\n  GLOBAL_OBJ,\n  registerSpanErrorInstrumentation,\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n  spanToJSON,\n  stripUrlQueryAndFragment,\n  vercelWaitUntil,\n} from '@sentry/core';\nimport type { VercelEdgeOptions } from '@sentry/vercel-edge';\nimport { getDefaultIntegrations, init as vercelEdgeInit } from '@sentry/vercel-edge';\nimport { addHeadersAsAttributes } from '../common/utils/addHeadersAsAttributes';\nimport { isBuild } from '../common/utils/isBuild';\nimport { flushSafelyWithTimeout } from '../common/utils/responseEnd';\nimport { distDirRewriteFramesIntegration } from './distDirRewriteFramesIntegration';\n\nexport * from '@sentry/vercel-edge';\nexport * from '../common';\nexport { captureUnderscoreErrorException } from '../common/pages-router-instrumentation/_error';\nexport { wrapApiHandlerWithSentry } from './wrapApiHandlerWithSentry';\n\nexport type EdgeOptions = VercelEdgeOptions;\n\nconst globalWithInjectedValues = GLOBAL_OBJ as typeof GLOBAL_OBJ & {\n  _sentryRewriteFramesDistDir?: string;\n  _sentryRelease?: string;\n};\n\n/** Inits the Sentry NextJS SDK on the Edge Runtime. */\nexport function init(options: VercelEdgeOptions = {}): void {\n  registerSpanErrorInstrumentation();\n\n  if (isBuild()) {\n    return;\n  }\n\n  const customDefaultIntegrations = getDefaultIntegrations(options);\n\n  // This value is injected at build time, based on the output directory specified in the build config. Though a default\n  // is set there, we set it here as well, just in case something has gone wrong with the injection.\n  const distDirName = process.env._sentryRewriteFramesDistDir || globalWithInjectedValues._sentryRewriteFramesDistDir;\n\n  if (distDirName) {\n    customDefaultIntegrations.push(distDirRewriteFramesIntegration({ distDirName }));\n  }\n\n  const opts = {\n    defaultIntegrations: customDefaultIntegrations,\n    release: process.env._sentryRelease || globalWithInjectedValues._sentryRelease,\n    ...options,\n  };\n\n  applySdkMetadata(opts, 'nextjs', ['nextjs', 'vercel-edge']);\n\n  const client = vercelEdgeInit(opts);\n\n  client?.on('spanStart', span => {\n    const spanAttributes = spanToJSON(span).data;\n    const rootSpan = getRootSpan(span);\n    const isRootSpan = span === rootSpan;\n\n    // Mark all spans generated by Next.js as 'auto'\n    if (spanAttributes?.['next.span_type'] !== undefined) {\n      span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN, 'auto');\n    }\n\n    // Make sure middleware spans get the right op\n    if (spanAttributes?.['next.span_type'] === 'Middleware.execute') {\n      span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_OP, 'http.server.middleware');\n      span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_SOURCE, 'url');\n    }\n\n    if (isRootSpan) {\n      // todo: check if we can set request headers for edge on sdkProcessingMetadata\n      const headers = getIsolationScope().getScopeData().sdkProcessingMetadata?.normalizedRequest?.headers;\n      addHeadersAsAttributes(headers, rootSpan);\n    }\n  });\n\n  // Use the preprocessEvent hook instead of an event processor, so that the users event processors receive the most\n  // up-to-date value, but also so that the logic that detects changes to the transaction names to set the source to\n  // \"custom\", doesn't trigger.\n  client?.on('preprocessEvent', event => {\n    // The otel auto inference will clobber the transaction name because the span has an http.target\n    if (\n      event.type === 'transaction' &&\n      event.contexts?.trace?.data?.['next.span_type'] === 'Middleware.execute' &&\n      event.contexts?.trace?.data?.['next.span_name']\n    ) {\n      if (event.transaction) {\n        event.transaction = stripUrlQueryAndFragment(event.contexts.trace.data['next.span_name']);\n      }\n    }\n  });\n\n  client?.on('spanEnd', span => {\n    if (span === getRootSpan(span)) {\n      vercelWaitUntil(flushSafelyWithTimeout());\n    }\n  });\n\n  try {\n    // @ts-expect-error `process.turbopack` is a magic string that will be replaced by Next.js\n    if (process.turbopack) {\n      getGlobalScope().setTag('turbopack', true);\n    }\n  } catch {\n    // Noop\n    // The statement above can throw because process is not defined on the client\n  }\n}\n\n/**\n * Just a passthrough in case this is imported from the client.\n */\nexport function withSentryConfig<T>(exportedUserNextConfig: T): T {\n  return exportedUserNextConfig;\n}\n"],"names":["vercelEdgeInit"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AA4BA,MAAM,wBAAA,GAA2B;;AAGjC;;AAEA;AACO,SAAS,IAAI,CAAC,OAAO,GAAsB,EAAE,EAAQ;AAC5D,EAAE,gCAAgC,EAAE;;AAEpC,EAAE,IAAI,OAAO,EAAE,EAAE;AACjB,IAAI;AACJ;;AAEA,EAAE,MAAM,yBAAA,GAA4B,sBAAsB,CAAC,OAAO,CAAC;;AAEnE;AACA;AACA,EAAE,MAAM,WAAA,GAAc,OAAO,CAAC,GAAG,CAAC,2BAAA,IAA+B,wBAAwB,CAAC,2BAA2B;;AAErH,EAAE,IAAI,WAAW,EAAE;AACnB,IAAI,yBAAyB,CAAC,IAAI,CAAC,+BAA+B,CAAC,EAAE,WAAA,EAAa,CAAC,CAAC;AACpF;;AAEA,EAAE,MAAM,OAAO;AACf,IAAI,mBAAmB,EAAE,yBAAyB;AAClD,IAAI,OAAO,EAAE,OAAO,CAAC,GAAG,CAAC,cAAA,IAAkB,wBAAwB,CAAC,cAAc;AAClF,IAAI,GAAG,OAAO;AACd,GAAG;;AAEH,EAAE,gBAAgB,CAAC,IAAI,EAAE,QAAQ,EAAE,CAAC,QAAQ,EAAE,aAAa,CAAC,CAAC;;AAE7D,EAAE,MAAM,MAAA,GAASA,MAAc,CAAC,IAAI,CAAC;;AAErC,EAAE,MAAM,EAAE,EAAE,CAAC,WAAW,EAAE,QAAQ;AAClC,IAAI,MAAM,iBAAiB,UAAU,CAAC,IAAI,CAAC,CAAC,IAAI;AAChD,IAAI,MAAM,QAAA,GAAW,WAAW,CAAC,IAAI,CAAC;AACtC,IAAI,MAAM,UAAA,GAAa,IAAA,KAAS,QAAQ;;AAExC;AACA,IAAI,IAAI,cAAc,GAAG,gBAAgB,CAAA,KAAM,SAAS,EAAE;AAC1D,MAAM,IAAI,CAAC,YAAY,CAAC,gCAAgC,EAAE,MAAM,CAAC;AACjE;;AAEA;AACA,IAAI,IAAI,cAAc,GAAG,gBAAgB,CAAA,KAAM,oBAAoB,EAAE;AACrE,MAAM,IAAI,CAAC,YAAY,CAAC,4BAA4B,EAAE,wBAAwB,CAAC;AAC/E,MAAM,IAAI,CAAC,YAAY,CAAC,gCAAgC,EAAE,KAAK,CAAC;AAChE;;AAEA,IAAI,IAAI,UAAU,EAAE;AACpB;AACA,MAAM,MAAM,OAAA,GAAU,iBAAiB,EAAE,CAAC,YAAY,EAAE,CAAC,qBAAqB,EAAE,iBAAiB,EAAE,OAAO;AAC1G,MAAM,sBAAsB,CAAC,OAAO,EAAE,QAAQ,CAAC;AAC/C;AACA,GAAG,CAAC;;AAEJ;AACA;AACA;AACA,EAAE,MAAM,EAAE,EAAE,CAAC,iBAAiB,EAAE,SAAS;AACzC;AACA,IAAI;AACJ,MAAM,KAAK,CAAC,IAAA,KAAS,aAAA;AACrB,MAAM,KAAK,CAAC,QAAQ,EAAE,KAAK,EAAE,IAAI,GAAG,gBAAgB,CAAA,KAAM,oBAAA;AAC1D,MAAM,KAAK,CAAC,QAAQ,EAAE,KAAK,EAAE,IAAI,GAAG,gBAAgB;AACpD,MAAM;AACN,MAAM,IAAI,KAAK,CAAC,WAAW,EAAE;AAC7B,QAAQ,KAAK,CAAC,WAAA,GAAc,wBAAwB,CAAC,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;AACjG;AACA;AACA,GAAG,CAAC;;AAEJ,EAAE,MAAM,EAAE,EAAE,CAAC,SAAS,EAAE,QAAQ;AAChC,IAAI,IAAI,IAAA,KAAS,WAAW,CAAC,IAAI,CAAC,EAAE;AACpC,MAAM,eAAe,CAAC,sBAAsB,EAAE,CAAC;AAC/C;AACA,GAAG,CAAC;;AAEJ,EAAE,IAAI;AACN;AACA,IAAI,IAAI,OAAO,CAAC,SAAS,EAAE;AAC3B,MAAM,cAAc,EAAE,CAAC,MAAM,CAAC,WAAW,EAAE,IAAI,CAAC;AAChD;AACA,IAAI,MAAM;AACV;AACA;AACA;AACA;;AAEA;AACA;AACA;AACO,SAAS,gBAAgB,CAAI,sBAAsB,EAAQ;AAClE,EAAE,OAAO,sBAAsB;AAC/B;;;;"}