{"version":3,"file":"pino.js","sources":["../../../src/integrations/pino.ts"],"sourcesContent":["import { tracingChannel } from 'node:diagnostics_channel';\nimport type { IntegrationFn, LogSeverityLevel } from '@sentry/core';\nimport {\n  _INTERNAL_captureLog,\n  addExceptionMechanism,\n  captureException,\n  captureMessage,\n  defineIntegration,\n  severityLevelFromString,\n  withScope,\n} from '@sentry/core';\nimport { addInstrumentationConfig } from '../sdk/injectLoader';\n\ntype LevelMapping = {\n  // Fortunately pino uses the same levels as Sentry\n  labels: { [level: number]: LogSeverityLevel };\n};\n\ntype Pino = {\n  levels: LevelMapping;\n};\n\ntype MergeObject = {\n  [key: string]: unknown;\n  err?: Error;\n};\n\ntype PinoHookArgs = [MergeObject, string, number];\n\ntype PinoOptions = {\n  error: {\n    /**\n     * Levels that trigger capturing of events.\n     *\n     * @default []\n     */\n    levels: LogSeverityLevel[];\n    /**\n     * By default, Sentry will mark captured errors as handled.\n     * Set this to `false` if you want to mark them as unhandled instead.\n     *\n     * @default true\n     */\n    handled: boolean;\n  };\n  log: {\n    /**\n     * Levels that trigger capturing of logs. Logs are only captured if\n     * `enableLogs` is enabled.\n     *\n     * @default [\"trace\", \"debug\", \"info\", \"warn\", \"error\", \"fatal\"]\n     */\n    levels: LogSeverityLevel[];\n  };\n};\n\nconst DEFAULT_OPTIONS: PinoOptions = {\n  error: { levels: [], handled: true },\n  log: { levels: ['trace', 'debug', 'info', 'warn', 'error', 'fatal'] },\n};\n\ntype DeepPartial<T> = {\n  [P in keyof T]?: T[P] extends object ? Partial<T[P]> : T[P];\n};\n\n/**\n * Integration for Pino logging library.\n * Captures Pino logs as Sentry logs and optionally captures some log levels as events.\n *\n * Requires Pino >=v8.0.0 and Node >=20.6.0 or >=18.19.0\n */\nexport const pinoIntegration = defineIntegration((userOptions: DeepPartial<PinoOptions> = {}) => {\n  const options: PinoOptions = {\n    error: { ...DEFAULT_OPTIONS.error, ...userOptions.error },\n    log: { ...DEFAULT_OPTIONS.log, ...userOptions.log },\n  };\n\n  return {\n    name: 'Pino',\n    setup: client => {\n      const enableLogs = !!client.getOptions().enableLogs;\n\n      addInstrumentationConfig({\n        channelName: 'pino-log',\n        // From Pino v9.10.0 a tracing channel is available directly from Pino:\n        // https://github.com/pinojs/pino/pull/2281\n        module: { name: 'pino', versionRange: '>=8.0.0 < 9.10.0', filePath: 'lib/tools.js' },\n        functionQuery: {\n          functionName: 'asJson',\n          kind: 'Sync',\n        },\n      });\n\n      const injectedChannel = tracingChannel('orchestrion:pino:pino-log');\n      const integratedChannel = tracingChannel('pino_asJson');\n\n      function onPinoStart(self: Pino, args: PinoHookArgs, result: string): void {\n        const [obj, message, levelNumber] = args;\n        const level = self?.levels?.labels?.[levelNumber] || 'info';\n\n        if (enableLogs && options.log.levels.includes(level)) {\n          const attributes: Record<string, unknown> = {\n            ...obj,\n            'sentry.origin': 'auto.logging.pino',\n            'pino.logger.level': levelNumber,\n          };\n\n          const parsedResult = JSON.parse(result) as { name?: string };\n\n          if (parsedResult.name) {\n            attributes['pino.logger.name'] = parsedResult.name;\n          }\n\n          _INTERNAL_captureLog({ level, message, attributes });\n        }\n\n        if (options.error.levels.includes(level)) {\n          const captureContext = {\n            level: severityLevelFromString(level),\n          };\n\n          withScope(scope => {\n            scope.addEventProcessor(event => {\n              event.logger = 'pino';\n\n              addExceptionMechanism(event, {\n                handled: options.error.handled,\n                type: 'pino',\n              });\n\n              return event;\n            });\n\n            if (obj.err) {\n              captureException(obj.err, captureContext);\n              return;\n            }\n\n            captureMessage(message, captureContext);\n          });\n        }\n      }\n\n      injectedChannel.end.subscribe(data => {\n        const { self, arguments: args, result } = data as { self: Pino; arguments: PinoHookArgs; result: string };\n        onPinoStart(self, args, result);\n      });\n\n      integratedChannel.end.subscribe(data => {\n        const {\n          instance,\n          arguments: args,\n          result,\n        } = data as { instance: Pino; arguments: PinoHookArgs; result: string };\n        onPinoStart(instance, args, result);\n      });\n    },\n  };\n}) satisfies IntegrationFn;\n"],"names":[],"mappings":"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"}